@using AdministrareBlocMVC.Models

@{
    ViewData["Title"] = "Export cheltuieli apartamente pe luna";
    var bloc = ViewBag.Bloc as Bloc;
    var scari = ViewBag.Scari as string[] ?? Array.Empty<string>();

    int luna = ViewBag.Luna ?? DateTime.Now.Month;
    int an = ViewBag.An ?? DateTime.Now.Year;
    string dataColectare = ViewBag.DataColectare as string ?? DateTime.Today.AddHours(9).ToString("yyyy-MM-ddTHH:mm");
    string oraSfarsit = ViewBag.OraSfarsit as string ?? "11:00";

    string lunaAnText = $"{luna:D2}/{an:D4}";
}

<h1>Export cheltuieli apartamente pe luna</h1>

@if (bloc == null)
{
    <div class="alert alert-danger">Eroare: blocul nu a fost incarcat.</div>
}
else
{
    <div class="mb-2">
        <b>Bloc:</b> @bloc.Nume <br />
        <span class="text-muted">@bloc.Adresa</span>
    </div>

    @if (TempData["Err"] != null)
    {
        <div class="alert alert-danger">@TempData["Err"]</div>
    }
    @if (TempData["Ok"] != null)
    {
        <div class="alert alert-success">@TempData["Ok"]</div>
    }

    <form asp-action="ExportCheltuieliApLuna" method="post" class="mt-3">
        @Html.AntiForgeryToken()

        <input type="hidden" name="blocId" value="@bloc.Id" />

        @* daca blocul are scari -> optional filtrare *@
        @if (scari.Length > 0)
        {
            <div class="form-group">
                <label>Scara (optional)</label>
                <select name="scara" class="form-control">
                    <option value="">-- Toate scarile --</option>
                    @foreach (var s in scari)
                    {
                        <option value="@s">@s</option>
                    }
                </select>
            </div>
        }

        <div class="form-group mt-2">
            <label>Luna / An</label>

            <input id="lunaAnPicker"
                   type="text"
                   class="form-control"
                   autocomplete="off"
                   required
                   value="@lunaAnText" />

            <input type="hidden" id="lunaHidden" name="luna" value="@luna" />
            <input type="hidden" id="anHidden" name="an" value="@an" />
        </div>

        <div class="form-group mt-2">
            <label>Data + ora colectarii</label>
            <input name="dataColectare" type="datetime-local" class="form-control" required value="@dataColectare" />
        </div>
        <div class="form-group mt-2">
            <label>Sfarsit interval orar de colectare</label>
            <input name="oraSfarsit" type="time" class="form-control" required value="@oraSfarsit" />
        </div>


        <div class="d-flex gap-2 mt-3">
            <button type="submit" class="btn btn-success">Descarca Excel</button>

            <button type="submit"
                    class="btn btn-primary"
                    formaction="@Url.Action("PublicaCheltuieliApLuna", "Intretinere")">
                Publica pentru locatari
            </button>

            <a asp-action="ListaPeBloc" asp-route-id="@bloc.Id" class="btn btn-secondary">Inapoi</a>
        </div>
    </form>
}

@section Scripts {
    <!-- jQuery UI Datepicker (month/year) -->
    <link rel="stylesheet" href="https://code.jquery.com/ui/1.13.3/themes/base/jquery-ui.css" />
    <script src="https://code.jquery.com/ui/1.13.3/jquery-ui.min.js"></script>

    <style>
        /* ascundem calendarul cu zile, lasam doar luna + an */
        .ui-datepicker-calendar { display: none !important; }
    </style>

    <script>
        (function () {
            const $picker = $("#lunaAnPicker");
            const $lunaHidden = $("#lunaHidden");
            const $anHidden = $("#anHidden");

            function syncHiddenFromUi(inst) {
                const year = $("#ui-datepicker-div .ui-datepicker-year :selected").val();
                const month = $("#ui-datepicker-div .ui-datepicker-month :selected").val(); // 0..11

                if (!year || month === undefined) return;

                const m = parseInt(month, 10) + 1;
                const y = parseInt(year, 10);

                if (!m || !y) return;

                // afisam MM/yyyy
                const mm = (m < 10 ? "0" + m : "" + m);
                $picker.val(mm + "/" + y);

                // hidden pentru controller
                $lunaHidden.val(m);
                $anHidden.val(y);
            }

            function setDatepickerFromInput() {
                const val = ($picker.val() || "").trim(); // "MM/yyyy"
                const m = val.match(/^(\d{2})\/(\d{4})$/);
                if (!m) return;

                const month = parseInt(m[1], 10);
                const year = parseInt(m[2], 10);

                if (!month || !year) return;

                // setam in datepicker (luna e 0..11)
                $picker.datepicker("setDate", new Date(year, month - 1, 1));
                $lunaHidden.val(month);
                $anHidden.val(year);
            }

            $picker.datepicker({
                changeMonth: true,
                changeYear: true,
                showButtonPanel: true,
                dateFormat: "mm/yy",
                onClose: function (dateText, inst) {
                    syncHiddenFromUi(inst);
                },
                beforeShow: function () {
                    setDatepickerFromInput();
                }
            });

            // initial sync
            setDatepickerFromInput();
        })();
    </script>
}

@model AdministrareBlocMVC.ViewModels.ApartamentCreateEditViewModel

@{
    ViewData["Title"] = "Editeaza apartament";
}

<h1>Editeaza</h1>

<h4>Apartament</h4>
<hr />
<div class="row">
    <div class="col-md-4">
        <form asp-action="Edit" method="post" id="frmEditAp">
            @Html.AntiForgeryToken()
            <div asp-validation-summary="All" class="text-danger"></div>

            <input type="hidden" asp-for="Id" />

            <div class="form-group">
                <label asp-for="Numar"></label>
                <input asp-for="Numar" class="form-control" />
                <span asp-validation-for="Numar" class="text-danger"></span>
            </div>

            <div class="form-group">
                <label asp-for="Etaj"></label>
                <input asp-for="Etaj" class="form-control" />
                <span asp-validation-for="Etaj" class="text-danger"></span>
            </div>

            <div class="form-group">
                <label asp-for="BlocId"></label>
                <select asp-for="BlocId" class="form-control" asp-items="ViewBag.BlocId"></select>
                <span asp-validation-for="BlocId" class="text-danger"></span>
            </div>

            <div class="form-group">
                <label asp-for="Scara"></label>
                <select asp-for="Scara" class="form-control" disabled>
                    <option value="">-- fara scara / selecteaza bloc --</option>
                </select>
                <span asp-validation-for="Scara" class="text-danger"></span>
            </div>

            <div class="form-group">
                <label asp-for="NumeProprietar"></label>
                <input asp-for="NumeProprietar" class="form-control" />
                <span asp-validation-for="NumeProprietar" class="text-danger"></span>
            </div>

            <div class="form-group">
                <label asp-for="NumarCamere"></label>
                <input asp-for="NumarCamere" class="form-control" />
                <span asp-validation-for="NumarCamere" class="text-danger"></span>
            </div>

            <div class="form-group">
                <label asp-for="SuprafataMp"></label>
                <!-- IMPORTANT: text ca sa poti scrie 24,2 -->
                <input asp-for="SuprafataMp" type="text" class="form-control" inputmode="decimal" />
                <span asp-validation-for="SuprafataMp" class="text-danger"></span>
            </div>

            <div class="form-group">
                <label asp-for="TelefonProprietar"></label>
                <input asp-for="TelefonProprietar" class="form-control" />
                <span asp-validation-for="TelefonProprietar" class="text-danger"></span>
            </div>

            <div class="form-group">
                <label asp-for="NrPersoane"></label>
                <input asp-for="NrPersoane" type="number" min="0" max="50" class="form-control" />
                <span asp-validation-for="NrPersoane" class="text-danger"></span>
            </div>

            <hr class="mt-4" />

            <input type="hidden" asp-for="AreChirias" />
            <input type="hidden" asp-for="StergeChiriasConfirmat" id="hdnStergeConfirm" />

            <div class="d-flex align-items-center gap-4 mt-2">
                <div class="form-check">
                    <input class="form-check-input" type="checkbox" asp-for="AdaugaChirias" id="chkChirias" />
                    <label class="form-check-label fw-bold" for="chkChirias">
                        Adauga chirias
                    </label>
                </div>

                @if (Model.AreChirias)
                {
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" asp-for="StergeChirias" id="chkSterge" />
                        <label class="form-check-label fw-bold text-danger" for="chkSterge">
                            Sterge chirias
                        </label>
                    </div>
                }
            </div>

            <div id="chiriasFields" class="mt-2" style="display:none;">
                <div class="form-group">
                    <label asp-for="NumeChirias"></label>
                    <input asp-for="NumeChirias" class="form-control" id="txtNumeChirias" />
                    <span asp-validation-for="NumeChirias" class="text-danger"></span>
                </div>

                <div class="form-group mt-2">
                    <label asp-for="TelefonChirias"></label>
                    <input asp-for="TelefonChirias" class="form-control" id="txtTelChirias" />
                    <span asp-validation-for="TelefonChirias" class="text-danger"></span>
                </div>
            </div>

            <div class="form-group mt-3">
                <input type="submit" value="Salveaza" class="btn btn-primary" />
                <a asp-action="Index" class="btn btn-secondary ms-2">Inapoi la blocuri</a>
            </div>
        </form>
    </div>
</div>

@section Scripts {
    @{
        await Html.RenderPartialAsync("_ValidationScriptsPartial");
    }

    <script>
        (function () {
            if (!window.jQuery || !jQuery.validator) return;

            const normalize = (v) => (v || "").toString().trim().replace(/\s/g, "").replace(",", ".");

            jQuery.validator.methods.number = function (value, element) {
                if (this.optional(element)) return true;
                return /^-?\d+([.,]\d+)?$/.test(value);
            };

            const originalRange = jQuery.validator.methods.range;
            jQuery.validator.methods.range = function (value, element, param) {
                if (this.optional(element)) return true;
                const n = parseFloat(normalize(value));
                if (isNaN(n)) return false;
                return n >= param[0] && n <= param[1];
            };
        })();

        async function incarcaScariEdit() {
            const blocId = document.getElementById("BlocId").value;
            const scaraSelect = document.getElementById("Scara");
            const scaraCurenta = "@(Model.Scara ?? "")";

            scaraSelect.innerHTML = '<option value="">-- fara scara / selecteaza bloc --</option>';
            scaraSelect.disabled = true;

            if (!blocId) return;

            const resp = await fetch(`/Apartament/GetScariByBloc?blocId=${blocId}`);
            const scari = await resp.json();

            if (!scari || scari.length === 0) {
                scaraSelect.innerHTML = '<option value="">-- fara scara --</option>';
                scaraSelect.value = "";
                scaraSelect.disabled = true;
                return;
            }

            scaraSelect.disabled = false;
            scaraSelect.innerHTML = '<option value="">-- selecteaza scara --</option>';

            for (const s of scari) {
                const opt = document.createElement("option");
                opt.value = s;
                opt.text = s;

                if (scaraCurenta && s.toLowerCase() === scaraCurenta.toLowerCase()) {
                    opt.selected = true;
                }

                scaraSelect.appendChild(opt);
            }
        }

        document.getElementById("BlocId").addEventListener("change", incarcaScariEdit);
        incarcaScariEdit();

        (function () {
            const chk = document.getElementById("chkChirias");
            const box = document.getElementById("chiriasFields");
            const nume = document.getElementById("txtNumeChirias");
            const tel = document.getElementById("txtTelChirias");
            const chkSterge = document.getElementById("chkSterge");
            const hdnStergeConfirm = document.getElementById("hdnStergeConfirm");

            const areChirias = (@Model.AreChirias.ToString().ToLower());

            function sync() {
                box.style.display = chk.checked ? "block" : "none";
            }

            chk.addEventListener("change", function () {

                if (!chk.checked && areChirias) {
                    alert("Pentru stergere foloseste checkbox-ul 'Sterge chirias'.");
                    chk.checked = true;
                    return;
                }

                if (!chk.checked) {
                    if (nume) nume.value = "";
                    if (tel) tel.value = "";
                }

                sync();
            });

            if (chkSterge) {
                chkSterge.addEventListener("change", function () {

                    if (chkSterge.checked) {
                        const ok = confirm("Sigur vrei sa stergi chiriasul?");
                        if (!ok) {
                            chkSterge.checked = false;
                            hdnStergeConfirm.value = "false";
                            return;
                        }

                        hdnStergeConfirm.value = "true";
                        chk.checked = false;
                        if (nume) nume.value = "";
                        if (tel) tel.value = "";
                        sync();
                    } else {
                        hdnStergeConfirm.value = "false";
                    }
                });
            }

            sync();
        })();
    </script>
}
